<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>MediaChat.mxml</title>
<link rel="stylesheet" type="text/css" href="../SourceStyles.css"/>
</head>

<body><pre><span class="MXMLProcessing_Instruction">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="MXMLComponent_Tag">&lt;mx:Application</span><span class="MXMLDefault_Text"> xmlns:mx=&quot;</span><span class="MXMLString">http://www.adobe.com/2006/mxml</span><span class="MXMLDefault_Text">&quot; layout=&quot;</span><span class="MXMLString">absolute</span><span class="MXMLDefault_Text">&quot; height=&quot;</span><span class="MXMLString">321</span><span class="MXMLDefault_Text">&quot; width=&quot;</span><span class="MXMLString">654</span><span class="MXMLDefault_Text">&quot; cornerRadius=&quot;</span><span class="MXMLString">0</span><span class="MXMLDefault_Text">&quot; backgroundGradientAlphas=&quot;</span><span class="MXMLString">[1.0, 1.0]</span><span class="MXMLDefault_Text">&quot; backgroundGradientColors=&quot;</span><span class="MXMLString">[#B0ACAC, #4C4B4B]</span><span class="MXMLDefault_Text">&quot; creationComplete=&quot;</span><span class="ActionScriptDefault_Text">Initialize</span><span class="ActionScriptBracket/Brace">()</span><span class="MXMLDefault_Text">&quot; viewSourceURL=&quot;</span><span class="MXMLString">srcview/index.html</span><span class="MXMLDefault_Text">&quot;</span><span class="MXMLComponent_Tag">&gt;</span>
  <span class="MXMLSpecial_Tag">&lt;mx:Script</span><span class="MXMLDefault_Text"> source=&quot;</span><span class="MXMLString">MediaChat.as</span><span class="MXMLDefault_Text">&quot; </span><span class="MXMLSpecial_Tag">/&gt;</span>
    <span class="MXMLComponent_Tag">&lt;mx:VideoDisplay</span><span class="MXMLDefault_Text"> id=&quot;</span><span class="MXMLString">videoOut</span><span class="MXMLDefault_Text">&quot; width=&quot;</span><span class="MXMLString">320</span><span class="MXMLDefault_Text">&quot; height=&quot;</span><span class="MXMLString">249</span><span class="MXMLDefault_Text">&quot; cornerRadius=&quot;</span><span class="MXMLString">4</span><span class="MXMLDefault_Text">&quot; y=&quot;</span><span class="MXMLString">4</span><span class="MXMLDefault_Text">&quot; x=&quot;</span><span class="MXMLString">4</span><span class="MXMLDefault_Text">&quot;</span><span class="MXMLComponent_Tag">/&gt;</span>
    <span class="MXMLComponent_Tag">&lt;mx:VBox</span><span class="MXMLDefault_Text"> x=&quot;</span><span class="MXMLString">2</span><span class="MXMLDefault_Text">&quot; y=&quot;</span><span class="MXMLString">2</span><span class="MXMLDefault_Text">&quot; height=&quot;</span><span class="MXMLString">253</span><span class="MXMLDefault_Text">&quot; width=&quot;</span><span class="MXMLString">324</span><span class="MXMLDefault_Text">&quot; borderStyle=&quot;</span><span class="MXMLString">solid</span><span class="MXMLDefault_Text">&quot; cornerRadius=&quot;</span><span class="MXMLString">4</span><span class="MXMLDefault_Text">&quot; horizontalAlign=&quot;</span><span class="MXMLString">center</span><span class="MXMLDefault_Text">&quot; verticalAlign=&quot;</span><span class="MXMLString">middle</span><span class="MXMLDefault_Text">&quot; verticalGap=&quot;</span><span class="MXMLString">0</span><span class="MXMLDefault_Text">&quot; borderColor=&quot;</span><span class="MXMLString">#636363</span><span class="MXMLDefault_Text">&quot;</span><span class="MXMLComponent_Tag">&gt;</span>

    <span class="MXMLComponent_Tag">&lt;/mx:VBox&gt;</span>
    <span class="MXMLComponent_Tag">&lt;mx:Button</span><span class="MXMLDefault_Text"> x=&quot;</span><span class="MXMLString">10</span><span class="MXMLDefault_Text">&quot; y=&quot;</span><span class="MXMLString">261</span><span class="MXMLDefault_Text">&quot; label=&quot;</span><span class="MXMLString">Старт</span><span class="MXMLDefault_Text">&quot; width=&quot;</span><span class="MXMLString">304</span><span class="MXMLDefault_Text">&quot; id=&quot;</span><span class="MXMLString">btnStart</span><span class="MXMLDefault_Text">&quot; click=&quot;</span><span class="ActionScriptDefault_Text">btnStartOnClick</span><span class="ActionScriptBracket/Brace">()</span>;<span class="MXMLDefault_Text">&quot;</span><span class="MXMLComponent_Tag">/&gt;</span>
    <span class="MXMLComponent_Tag">&lt;mx:Button</span><span class="MXMLDefault_Text"> x=&quot;</span><span class="MXMLString">334</span><span class="MXMLDefault_Text">&quot; y=&quot;</span><span class="MXMLString">261</span><span class="MXMLDefault_Text">&quot; label=&quot;</span><span class="MXMLString">Пригласить</span><span class="MXMLDefault_Text">&quot; width=&quot;</span><span class="MXMLString">304</span><span class="MXMLDefault_Text">&quot; id=&quot;</span><span class="MXMLString">btnStartVideo</span><span class="MXMLDefault_Text">&quot;</span><span class="MXMLComponent_Tag">/&gt;</span>
    <span class="MXMLComponent_Tag">&lt;mx:HSlider</span><span class="MXMLDefault_Text"> x=&quot;</span><span class="MXMLString">364</span><span class="MXMLDefault_Text">&quot; y=&quot;</span><span class="MXMLString">300</span><span class="MXMLDefault_Text">&quot; width=&quot;</span><span class="MXMLString">280</span><span class="MXMLDefault_Text">&quot;</span><span class="MXMLComponent_Tag">/&gt;</span>
    <span class="MXMLComponent_Tag">&lt;mx:CheckBox</span><span class="MXMLDefault_Text"> x=&quot;</span><span class="MXMLString">341</span><span class="MXMLDefault_Text">&quot; y=&quot;</span><span class="MXMLString">295</span><span class="MXMLDefault_Text">&quot; width=&quot;</span><span class="MXMLString">21</span><span class="MXMLDefault_Text">&quot;</span><span class="MXMLComponent_Tag">/&gt;</span>
    <span class="MXMLComponent_Tag">&lt;mx:Button</span><span class="MXMLDefault_Text"> x=&quot;</span><span class="MXMLString">10</span><span class="MXMLDefault_Text">&quot; y=&quot;</span><span class="MXMLString">291</span><span class="MXMLDefault_Text">&quot; label=&quot;</span><span class="MXMLString">Выкл. видео</span><span class="MXMLDefault_Text">&quot; width=&quot;</span><span class="MXMLString">150</span><span class="MXMLDefault_Text">&quot; id=&quot;</span><span class="MXMLString">btnStopMyVideo</span><span class="MXMLDefault_Text">&quot;</span><span class="MXMLComponent_Tag">/&gt;</span>
    <span class="MXMLComponent_Tag">&lt;mx:Button</span><span class="MXMLDefault_Text"> x=&quot;</span><span class="MXMLString">163</span><span class="MXMLDefault_Text">&quot; y=&quot;</span><span class="MXMLString">291</span><span class="MXMLDefault_Text">&quot; label=&quot;</span><span class="MXMLString">Выкл. микрофон</span><span class="MXMLDefault_Text">&quot; width=&quot;</span><span class="MXMLString">151</span><span class="MXMLDefault_Text">&quot; id=&quot;</span><span class="MXMLString">btnStopMyAudio</span><span class="MXMLDefault_Text">&quot;</span><span class="MXMLComponent_Tag">/&gt;</span>
    <span class="MXMLComponent_Tag">&lt;mx:Text</span><span class="MXMLDefault_Text"> x=&quot;</span><span class="MXMLString">334</span><span class="MXMLDefault_Text">&quot; y=&quot;</span><span class="MXMLString">281</span><span class="MXMLDefault_Text">&quot; text=&quot;</span><span class="MXMLString">выкл.</span><span class="MXMLDefault_Text">&quot;</span><span class="MXMLComponent_Tag">/&gt;</span>
    <span class="MXMLComponent_Tag">&lt;mx:Image</span><span class="MXMLDefault_Text"> x=&quot;</span><span class="MXMLString">332</span><span class="MXMLDefault_Text">&quot; y=&quot;</span><span class="MXMLString">4</span><span class="MXMLDefault_Text">&quot; height=&quot;</span><span class="MXMLString">13</span><span class="MXMLDefault_Text">&quot; width=&quot;</span><span class="MXMLString">12</span><span class="MXMLDefault_Text">&quot;</span><span class="MXMLComponent_Tag">/&gt;</span>
    <span class="MXMLComponent_Tag">&lt;mx:VideoDisplay</span><span class="MXMLDefault_Text"> id=&quot;</span><span class="MXMLString">videoIn</span><span class="MXMLDefault_Text">&quot; width=&quot;</span><span class="MXMLString">320</span><span class="MXMLDefault_Text">&quot; height=&quot;</span><span class="MXMLString">249</span><span class="MXMLDefault_Text">&quot; cornerRadius=&quot;</span><span class="MXMLString">4</span><span class="MXMLDefault_Text">&quot; y=&quot;</span><span class="MXMLString">4</span><span class="MXMLDefault_Text">&quot; x=&quot;</span><span class="MXMLString">330</span><span class="MXMLDefault_Text">&quot;</span><span class="MXMLComponent_Tag">/&gt;</span>
    <span class="MXMLComponent_Tag">&lt;mx:VBox</span><span class="MXMLDefault_Text"> x=&quot;</span><span class="MXMLString">328</span><span class="MXMLDefault_Text">&quot; y=&quot;</span><span class="MXMLString">2</span><span class="MXMLDefault_Text">&quot; height=&quot;</span><span class="MXMLString">253</span><span class="MXMLDefault_Text">&quot; width=&quot;</span><span class="MXMLString">324</span><span class="MXMLDefault_Text">&quot; borderStyle=&quot;</span><span class="MXMLString">solid</span><span class="MXMLDefault_Text">&quot; cornerRadius=&quot;</span><span class="MXMLString">4</span><span class="MXMLDefault_Text">&quot; horizontalAlign=&quot;</span><span class="MXMLString">center</span><span class="MXMLDefault_Text">&quot; verticalAlign=&quot;</span><span class="MXMLString">middle</span><span class="MXMLDefault_Text">&quot; verticalGap=&quot;</span><span class="MXMLString">0</span><span class="MXMLDefault_Text">&quot; borderColor=&quot;</span><span class="MXMLString">#636363</span><span class="MXMLDefault_Text">&quot;</span><span class="MXMLComponent_Tag">&gt;</span>

    <span class="MXMLComponent_Tag">&lt;/mx:VBox&gt;</span>
<span class="MXMLComment">&lt;!--</span><span class="MXMLComment">      &lt;mx:Script&gt;&lt;![CDATA[
import flash.events.KeyboardEvent;
import flash.events.NetStatusEvent;
import flash.media.Camera;
import flash.media.Microphone;
import flash.media.Video;
import flash.net.NetConnection;
import flash.net.NetStream;
import flash.net.ObjectEncoding;

import mx.controls.Alert;
import mx.core.IFlexDisplayObject;
import mx.events.FlexEvent;


private var baseAddr:String = &quot;localhost&quot;;
private var id_member:String, id_partner:String;

public var cam:Camera = null;
public var videoModel:Video = new Video;
public var mic:Microphone = null;
private var nc:NetConnection = new NetConnection();

//public var mClient:FMSConnector=new FMSConnector();

private var ns:NetStream = null;

private var bConnect:Boolean = false;
private var timeRefreshInterval:Number = 9000;
public var dataTimer:Timer;


public function Initialize():void {
     
     
 btnStartVideo.enabled = false;
 btnStopMyVideo.enabled = false;
 btnStopMyAudio.enabled = false;

    id_member = &quot;ksen&quot;;//Application.application.parameters.uid;
    id_partner = &quot;vovboc&quot;;//Application.application.parameters.chid;
        // Добавляем обработчики событий для объекта NetConnection
        nc.addEventListener(NetStatusEvent.NET_STATUS, onNCStatus);
        nc.addEventListener(SecurityErrorEvent.SECURITY_ERROR, securityErrorHandler);
        nc.addEventListener(AsyncErrorEvent.ASYNC_ERROR, asyncErrorHandler);
        
        nc.objectEncoding=ObjectEncoding.AMF0;        



 }
 
 private function btnStartOnClick():void {
     


     if (btnStart.label == &quot;Старт&quot;)
     {
        nc.connect(&quot;rtmp://&quot; + baseAddr + &quot;/MediaChat&quot;, true);
      }
      else
      {
          btnStart.label = &quot;Старт&quot;;
         btnStartVideo.enabled = false;
         btnStopMyVideo.enabled = false;
         btnStopMyAudio.enabled = false;
          ns.close();
          nc.close();
          videoOut.stop();

      
      }
 
 }
 
    private function securityErrorHandler(event:SecurityErrorEvent):void
    {
    }

    private function asyncErrorHandler(event:AsyncErrorEvent):void
    {
    }

    // Обработчик статуса соединения
    private function onNCStatus(event:NetStatusEvent):void
    {
        switch (event.info.code) {
            // При успешном соединении
            case &quot;NetConnection.Connect.Success&quot;:
                // Создаём стрим на основе объекта соединения
                ns = new NetStream(nc);
                // Добавляем обработчики событий чтобы не ругался
                ns.addEventListener(AsyncErrorEvent.ASYNC_ERROR, asyncErrorHandler);
                ns.addEventListener(NetStatusEvent.NET_STATUS, onNCStatus);
                 if (cam == null)    
                     {
                     cam = Camera.getCamera();
                     if (cam==null)
                         {
        
                        Alert.show(&quot;Камера не обнаружена!&quot;);
                        return;
    
                         }
                    cam.setMode(213, 160, 10);
                    cam.setQuality(50000, 90);
                     }
                 if (mic == null)    mic = Microphone.getMicrophone()
                
                // Соединяем стрим с вебкамерой
                ns.attachCamera(cam);
                ns.attachAudio(mic);
                videoOut.attachCamera(cam);
                // Запускаем передачу данных
                ns.publish(id_member + id_partner);
                 btnStartVideo.enabled = true;
                 btnStopMyVideo.enabled = true;
                 btnStopMyAudio.enabled = true;
                 btnStart.label = &quot;Стоп&quot;;
                break;
            case &quot;NetConnection.Connect.Failed&quot;:
                Alert.show(&quot;Невозможно установить соединение с сервером!&quot;);    
        }   
    }
  ]]&gt;&lt;/mx:Script&gt;</span><span class="MXMLComment">--&gt;</span>
<span class="MXMLComponent_Tag">&lt;/mx:Application&gt;</span></pre></body>
</html>
